<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Review your application to Craw Hammer Trades School. Check your submitted information before final submission.">
    <link rel="canonical" href="https://crawhammertrades.com/review.html">
    <title>Review Application | Craw Hammer Trades School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" media="print" onload="this.media='all'; this.onload=null;">
    <noscript><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"></noscript>
    <link href="css/site.css" rel="stylesheet">
    <style>
        @media (max-width: 640px) {
            .review-section {
                border-radius: 0.75rem;
            }
            .review-header {
                padding: 1rem;
            }
        }
        
        .info-field {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .info-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #ea580c;
        }
        
        .info-value {
            font-size: 0.95rem;
            font-weight: 500;
            color: #1e293b;
            word-break: break-word;
        }
        
        @media (max-width: 640px) {
            .info-value {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 font-sans text-slate-900">
    <!-- Navigation -->
    <nav id="navbar-placeholder" class="glass sticky top-0 z-40 rounded-b-2xl mx-2 mt-2"></nav>
    
    <!-- Skip Link -->
    <a href="#main-content" class="skip-link">Skip to content</a>

    <!-- Main Content -->
    <main id="main-content" class="max-w-4xl mx-auto px-3 sm:px-4 py-6 sm:py-12">
        
        <!-- Progress Bar -->
        <div class="mb-8 flex justify-between items-center text-xs sm:text-sm font-bold text-slate-400 max-w-2xl mx-auto">
            <span class="text-blue-900">1. Fill</span>
            <div class="h-1 flex-1 mx-2 sm:mx-4 bg-blue-900 rounded"></div>
            <span class="text-blue-900">2. Review</span>
            <div class="h-1 flex-1 mx-2 sm:mx-4 bg-blue-900 rounded"></div>
            <span class="text-orange-600">3. Submit</span>
        </div>

        <!-- Review Card Container -->
        <div class="bg-white rounded-2xl sm:rounded-3xl overflow-hidden shadow-lg">
            
            <!-- Header -->
            <div class="review-header bg-gradient-to-r from-blue-900 to-blue-800 p-4 sm:p-8 text-white flex justify-between items-start sm:items-center flex-col sm:flex-row gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-black uppercase mb-1">Review Your Application</h1>
                    <p class="text-xs sm:text-sm text-blue-100">Please verify all information is correct before submitting</p>
                </div>
                <button id="edit-btn" class="w-full sm:w-auto text-sm bg-orange-600 hover:bg-orange-700 text-white px-4 sm:px-6 py-2 sm:py-2.5 rounded-lg font-bold transition flex items-center justify-center gap-2">
                    <i class="fas fa-edit"></i>
                    <span>Edit Info</span>
                </button>
            </div>

            <!-- Content Area -->
            <div id="review-content" class="p-4 sm:p-8 space-y-6 sm:space-y-8">
                <!-- Loading State -->
                <div class="flex flex-col items-center justify-center py-12 text-center">
                    <div class="animate-spin mb-4">
                        <i class="fas fa-spinner text-4xl text-blue-900"></i>
                    </div>
                    <p class="text-slate-600 text-sm sm:text-base">Loading your application...</p>
                </div>
            </div>

            <!-- Submit Section -->
            <div id="submit-section" class="p-4 sm:p-8 bg-slate-50 border-t-2 border-slate-200 space-y-6">
                
                <!-- Confirmation Checkbox -->
                <div class="flex items-start gap-3 p-4 border-2 border-slate-300 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition">
                    <input type="checkbox" id="confirm" class="mt-1 w-5 h-5 rounded border-2 border-slate-300 text-orange-600 cursor-pointer accent-orange-600 flex-shrink-0">
                    <label for="confirm" class="text-sm text-slate-700 leading-snug cursor-pointer flex-1">
                        <span class="font-semibold">I confirm that all information is accurate and complete.</span> I understand that providing false information or documents will lead to automatic disqualification and may have legal consequences.
                    </label>
                </div>

                <!-- File Validation Notice -->
                <div id="files-notice" class="flex gap-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <i class="fas fa-info-circle text-blue-600 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-semibold text-blue-900 mb-1">Important: Files Required</p>
                        <p class="text-xs text-blue-800">Your application requires the following files to be submitted:</p>
                        <ul class="text-xs text-blue-800 mt-2 ml-4 space-y-1">
                            <li><i class="fas fa-check text-green-600"></i> Payment receipt (Zanaco Bill Muster)</li>
                            <li><i class="fas fa-check text-green-600"></i> School results or certificates</li>
                            <li><i class="fas fa-file text-slate-600"></i> Additional supporting documents (optional)</li>
                        </ul>
                    </div>
                </div>

                <!-- Submit Button -->
                <button id="submit-btn" disabled class="w-full bg-gradient-to-r from-orange-600 to-orange-700 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-lg sm:rounded-xl font-bold text-base sm:text-lg hover:from-orange-700 hover:to-orange-800 transition shadow-lg shadow-orange-300 disabled:from-slate-400 disabled:to-slate-400 disabled:cursor-not-allowed disabled:shadow-none uppercase flex items-center justify-center gap-2">
                    <i class="fas fa-paper-plane"></i>
                    <span id="submit-text">Confirm & Submit Application</span>
                </button>

                <p class="text-center text-slate-600 text-xs sm:text-sm">
                    <i class="fas fa-lock text-green-600 mr-1"></i>
                    Your information is secure and encrypted. Data used only for admission purposes.
                </p>
            </div>
        </div>

        <!-- Message After Load -->
        <p class="text-center text-slate-600 text-xs sm:text-sm mt-6 px-4">
            Need to make changes? Click the "Edit Info" button to go back and modify your application.
        </p>
    </main>

    <!-- Loading/Submitting Modal -->
    <div id="submitting-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl sm:rounded-3xl p-6 sm:p-10 max-w-sm w-full text-center">
            <div class="mb-6">
                <div class="inline-block animate-spin">
                    <i class="fas fa-circle-notch text-5xl text-blue-900"></i>
                </div>
            </div>
            <h2 class="text-xl sm:text-2xl font-bold text-blue-900 mb-2">Submitting Application</h2>
            <p class="text-sm sm:text-base text-slate-600 mb-6">Please wait while we process your application...</p>
            <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                <div id="progress-bar" class="bg-gradient-to-r from-orange-600 to-orange-700 h-2 rounded-full transition-all duration-500" style="width: 10%;"></div>
            </div>
            <p class="text-xs text-slate-500 mt-4">Do not close this window</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-gradient-to-b from-blue-900/95 to-blue-900/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl sm:rounded-3xl p-6 sm:p-10 max-w-md w-full text-center">
            <div class="w-16 sm:w-20 h-16 sm:h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
                <i class="fas fa-check text-3xl sm:text-4xl"></i>
            </div>
            <h2 class="text-2xl sm:text-3xl font-extrabold text-blue-900 mb-2">Application Received!</h2>
            <p id="success-message" class="text-sm sm:text-base text-slate-600 mb-6">Thank you! Your application has been submitted successfully.</p>
            
            <div class="mt-6 sm:mt-8 p-4 bg-orange-50 border-2 border-orange-200 rounded-lg text-left">
                <p class="text-xs font-bold text-orange-800 uppercase mb-3 flex items-center gap-2">
                    <i class="fas fa-tasks"></i> What happens next?
                </p>
                <ul class="text-xs sm:text-sm text-slate-700 space-y-3">
                    <li class="flex gap-3">
                        <span class="bg-orange-600 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 text-xs font-bold">1</span>
                        <span><strong>Confirmation Email:</strong> You'll receive an email confirming receipt of your application</span>
                    </li>
                    <li class="flex gap-3">
                        <span class="bg-orange-600 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 text-xs font-bold">2</span>
                        <span><strong>Document Review:</strong> Our team will review your submitted documents (2-3 business days)</span>
                    </li>
                    <li class="flex gap-3">
                        <span class="bg-orange-600 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 text-xs font-bold">3</span>
                        <span><strong>Follow-up Call:</strong> We'll contact you within 48 hours to discuss your application</span>
                    </li>
                </ul>
            </div>

            <div class="mt-6 sm:mt-8 space-y-3">
                <a href="index.html" class="block w-full border-2 border-blue-900 text-blue-900 py-2.5 sm:py-3 rounded-lg font-bold hover:bg-blue-900 hover:text-white transition text-sm sm:text-base">
                    Return to Home
                </a>
                <p class="text-xs text-slate-500 px-4">
                    <i class="fas fa-envelope mr-1"></i> Keep an eye on your inbox for updates
                </p>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-red-900/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl sm:rounded-3xl p-6 sm:p-10 max-w-md w-full text-center">
            <div class="w-16 sm:w-20 h-16 sm:h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-exclamation text-3xl sm:text-4xl"></i>
            </div>
            <h2 class="text-2xl sm:text-3xl font-extrabold text-red-900 mb-2">Submission Failed</h2>
            <p id="error-message" class="text-sm sm:text-base text-slate-600 mb-6">An error occurred while submitting your application. Please try again.</p>
            
            <button onclick="closeErrorModal()" class="block w-full bg-red-900 text-white py-2.5 sm:py-3 rounded-lg font-bold hover:bg-red-800 transition text-sm sm:text-base">
                Try Again
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/main.js" defer></script>
    <script>
        let applicationData = {};
        let applicationFiles = { proofOfPayment: null, resultsCert: null, attachments: [] };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadApplicationData();
            setupEventListeners();
        });

        // Load application data from session storage
        async function loadApplicationData() {
            try {
                const data = sessionStorage.getItem('applicationData');
                const files = sessionStorage.getItem('applicationFiles');
                
                if (!data) {
                    // No data - redirect back to application form
                    window.location.href = 'apply.html';
                    return;
                }
                
                applicationData = JSON.parse(data);
                const fileInfo = files ? JSON.parse(files) : {};
                
                // Retrieve File objects from IndexedDB (stored as Blobs)
                try {
                    const dbFiles = await getFilesFromIndexedDB();
                    if (dbFiles && (dbFiles.proofOfPayment || dbFiles.resultsCert || dbFiles.attachments.length > 0)) {
                        applicationFiles = dbFiles;
                        console.log('Files retrieved from IndexedDB:', {
                            hasPaymentReceipt: !!applicationFiles.proofOfPayment,
                            hasSchoolResults: !!applicationFiles.resultsCert,
                            attachmentCount: applicationFiles.attachments.length
                        });
                    } else {
                        console.warn('Warning: No files found in IndexedDB');
                    }
                } catch (dbErr) {
                    console.error('Error retrieving files from IndexedDB:', dbErr);
                }
                
                // Check if required files are present
                const hasPaymentReceipt = fileInfo.proofOfPayment !== null;
                const hasSchoolResults = fileInfo.resultsCert !== null;
                
                // Store file info for later submission
                applicationData.hasPaymentReceipt = hasPaymentReceipt;
                applicationData.hasSchoolResults = hasSchoolResults;
                applicationData.fileInfo = fileInfo;
                
                renderReviewContent();
            } catch (err) {
                console.error('Error loading application data:', err);
                window.location.href = 'apply.html';
            }
        }

        // IndexedDB helper - retrieve files
        function getFilesFromIndexedDB() {
            return new Promise((resolve, reject) => {
                try {
                    const request = indexedDB.open('ApplicationDatabase', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        const db = request.result;
                        const tx = db.transaction('applicationFiles', 'readonly');
                        const store = tx.objectStore('applicationFiles');
                        const getAllRequest = store.getAll();
                        
                        getAllRequest.onerror = () => reject(getAllRequest.error);
                        getAllRequest.onsuccess = () => {
                            const records = getAllRequest.result;
                            const files = {
                                proofOfPayment: null,
                                resultsCert: null,
                                attachments: []
                            };
                            
                            records.forEach(record => {
                                if (record.type === 'proofOfPayment') {
                                    // Convert Blob back to File
                                    files.proofOfPayment = new File([record.blob], record.name, { type: record.mimeType });
                                } else if (record.type === 'resultsCert') {
                                    // Convert Blob back to File
                                    files.resultsCert = new File([record.blob], record.name, { type: record.mimeType });
                                } else if (record.type === 'attachment') {
                                    // Convert Blob back to File
                                    files.attachments.push(new File([record.blob], record.name, { type: record.mimeType }));
                                }
                            });
                            
                            resolve(files);
                        };
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('applicationFiles')) {
                            db.createObjectStore('applicationFiles', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                } catch (err) {
                    reject(err);
                }
            });
        }

        // IndexedDB helper - open database
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ApplicationDatabase', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('applicationFiles')) {
                        db.createObjectStore('applicationFiles', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        // Render the review content
        function renderReviewContent() {
            const d = applicationData;
            
            // Parse subjects
            let subjectsHtml = '<p class="text-slate-600 text-sm">No subjects recorded</p>';
            try {
                const subjects = JSON.parse(d.subjectsGrades || '[]');
                if (subjects.length > 0) {
                    subjectsHtml = '<div class="space-y-2">' + subjects.map(s => {
                        return `<div class="flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-200">
                                    <span class="font-medium text-sm text-slate-700">${escapeHtml(s.subject)}</span>
                                    <span class="bg-blue-600 text-white px-3 py-1 rounded-full font-bold text-xs">${escapeHtml(s.grade)}</span>
                                </div>`;
                    }).join('') + '</div>';
                }
            } catch(e) {
                subjectsHtml = '<p class="text-slate-600 text-sm">Error loading subjects</p>';
            }

            const contentHtml = `
                <!-- Personal Information -->
                <section class="review-section">
                    <h2 class="text-lg sm:text-xl font-bold text-blue-900 mb-4 pb-3 border-b-2 border-orange-500 flex items-center gap-2">
                        <i class="fas fa-user text-orange-600"></i> Personal Information
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                        <div class="info-field">
                            <span class="info-label">Full Name</span>
                            <span class="info-value font-semibold text-base sm:text-lg">${escapeHtml(d.surname || '')} ${escapeHtml(d.firstname || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">NRC Number</span>
                            <span class="info-value font-mono font-semibold">${escapeHtml(d.nrc || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Gender</span>
                            <span class="info-value">${escapeHtml(d.gender || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Date of Birth</span>
                            <span class="info-value">${escapeHtml(d.dob || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Nationality</span>
                            <span class="info-value">${escapeHtml(d.nationality || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Contact Number</span>
                            <span class="info-value font-mono">${escapeHtml(d.cell || '')}</span>
                        </div>
                        <div class="info-field sm:col-span-2">
                            <span class="info-label">Email Address</span>
                            <span class="info-value break-all text-sm">${escapeHtml(d.email || 'Not provided')}</span>
                        </div>
                        <div class="info-field sm:col-span-2">
                            <span class="info-label">Residential Address</span>
                            <span class="info-value text-sm whitespace-pre-wrap">${escapeHtml(d.address || '')}</span>
                        </div>
                    </div>
                </section>

                <!-- Educational Background -->
                <section class="review-section">
                    <h2 class="text-lg sm:text-xl font-bold text-blue-900 mb-4 pb-3 border-b-2 border-orange-500 flex items-center gap-2">
                        <i class="fas fa-graduation-cap text-orange-600"></i> Educational Background
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                        <div class="info-field sm:col-span-2">
                            <span class="info-label">Last School Attended</span>
                            <span class="info-value">${escapeHtml(d.lastSchool || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Education Level Attained</span>
                            <span class="info-value">${escapeHtml(d.educationAttained || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Year of Completion</span>
                            <span class="info-value">${escapeHtml(d.yearCompleted || '')}</span>
                        </div>
                        <div class="info-field sm:col-span-2">
                            <span class="info-label">Previous Qualifications</span>
                            <span class="info-value text-sm">${escapeHtml(d.prevQualifications || 'None recorded')}</span>
                        </div>
                        <div class="info-field sm:col-span-2">
                            <span class="info-label">✓ Selected Subjects & Grades (${(() => {
                                try {
                                    const s = JSON.parse(d.subjectsGrades || '[]');
                                    return s.length;
                                } catch(e) {
                                    return 0;
                                }
                            })()})</span>
                            ${subjectsHtml}
                        </div>
                    </div>
                </section>

                <!-- Course Selection -->
                <section class="review-section">
                    <h2 class="text-lg sm:text-xl font-bold text-blue-900 mb-4 pb-3 border-b-2 border-orange-500 flex items-center gap-2">
                        <i class="fas fa-book text-orange-600"></i> Course Selection & Study Preferences
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                        <div class="info-field">
                            <span class="info-label">1st Choice Program</span>
                            <span class="inline-block bg-blue-100 text-blue-900 px-3 py-2 rounded-full text-sm font-bold mt-1">${escapeHtml(d.choice1 || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">2nd Choice Program</span>
                            <span class="info-value">${escapeHtml(d.choice2 || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Mode of Study</span>
                            <span class="inline-block bg-orange-100 text-orange-900 px-3 py-1 rounded-lg text-sm font-semibold mt-1">${escapeHtml(d.mode || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Level of Study</span>
                            <span class="info-value">${escapeHtml(d.level || '')}</span>
                        </div>
                    </div>
                </section>

                <!-- Sponsor Information -->
                <section class="review-section">
                    <h2 class="text-lg sm:text-xl font-bold text-blue-900 mb-4 pb-3 border-b-2 border-orange-500 flex items-center gap-2">
                        <i class="fas fa-users text-orange-600"></i> Sponsor Information
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                        <div class="info-field sm:col-span-2">
                            <span class="info-label">Sponsor Full Name</span>
                            <span class="info-value font-semibold">${escapeHtml(d.sponsorName || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Relationship to Applicant</span>
                            <span class="info-value">${escapeHtml(d.sponsorRelation || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Occupation</span>
                            <span class="info-value">${escapeHtml(d.sponsorOccupation || 'Not specified')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Contact Number</span>
                            <span class="info-value font-mono">${escapeHtml(d.sponsorCell || 'Not provided')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Email Address</span>
                            <span class="info-value text-sm break-all">${escapeHtml(d.sponsorEmail || '')}</span>
                        </div>
                        <div class="info-field sm:col-span-2">
                            <span class="info-label">Postal Address</span>
                            <span class="info-value text-sm whitespace-pre-wrap">${escapeHtml(d.sponsorPostal || '')}</span>
                        </div>
                    </div>
                </section>

                <!-- Application Details & Confirmations -->
                <section class="review-section">
                    <h2 class="text-lg sm:text-xl font-bold text-blue-900 mb-4 pb-3 border-b-2 border-orange-500 flex items-center gap-2">
                        <i class="fas fa-check-circle text-orange-600"></i> Application Details
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                        <div class="info-field">
                            <span class="info-label">Application Date</span>
                            <span class="info-value">${escapeHtml(d.applicationDate || '')}</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Payment Method</span>
                            <span class="info-value">Zanaco Bill Muster</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Application Fee</span>
                            <span class="inline-block bg-orange-100 text-orange-900 px-3 py-1 rounded-lg font-bold text-sm mt-1">K100</span>
                        </div>
                        <div class="info-field">
                            <span class="info-label">Bank Account Number</span>
                            <span class="info-value font-mono font-bold text-blue-900">0596204400114</span>
                        </div>
                    </div>
                </section>

                <!-- Confirmations Checklist -->
                <section class="review-section bg-blue-50 border border-blue-200">
                    <h2 class="text-lg sm:text-xl font-bold text-blue-900 mb-4 pb-3 border-b-2 border-blue-300 flex items-center gap-2">
                        <i class="fas fa-tasks text-blue-600"></i> Confirmations
                    </h2>
                    <div class="space-y-3">
                        <div class="flex items-start gap-3">
                            <span class="text-green-600 mt-1"><i class="fas fa-check-circle text-lg flex-shrink-0"></i></span>
                            <div>
                                <p class="font-semibold text-blue-900 text-sm">Identity Confirmation</p>
                                <p class="text-xs text-blue-800 mt-0.5">You confirm to be the person submitting this application</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="text-green-600 mt-1"><i class="fas fa-check-circle text-lg flex-shrink-0"></i></span>
                            <div>
                                <p class="font-semibold text-blue-900 text-sm">Intent & Commitment</p>
                                <p class="text-xs text-blue-800 mt-0.5">You declare genuine intent to enroll and commit to the course</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="text-green-600 mt-1"><i class="fas fa-check-circle text-lg flex-shrink-0"></i></span>
                            <div>
                                <p class="font-semibold text-blue-900 text-sm">Information Integrity</p>
                                <p class="text-xs text-blue-800 mt-0.5">All provided information is true, complete, and accurate</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Files Summary -->
                <section class="review-section bg-orange-50 border border-orange-200">
                    <h2 class="text-lg sm:text-xl font-bold text-blue-900 mb-4 pb-3 border-b-2 border-orange-300 flex items-center gap-2">
                        <i class="fas fa-file-upload text-orange-600"></i> Attached Documents
                    </h2>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3 p-3 ${applicationData.hasPaymentReceipt ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'} rounded-lg">
                            <i class="fas ${applicationData.hasPaymentReceipt ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600'} text-lg flex-shrink-0"></i>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm ${applicationData.hasPaymentReceipt ? 'text-green-900' : 'text-red-900'}">Payment Receipt</p>
                                <p class="text-xs ${applicationData.hasPaymentReceipt ? 'text-green-800' : 'text-red-800'}">
                                    ${applicationData.hasPaymentReceipt ? `<i class="fas fa-check mr-1"></i>${escapeHtml(applicationData.fileInfo?.proofOfPayment?.name || '')}` : 'Not uploaded (Required)'}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 ${applicationData.hasSchoolResults ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'} rounded-lg">
                            <i class="fas ${applicationData.hasSchoolResults ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600'} text-lg flex-shrink-0"></i>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-sm ${applicationData.hasSchoolResults ? 'text-green-900' : 'text-red-900'}">School Results</p>
                                <p class="text-xs ${applicationData.hasSchoolResults ? 'text-green-800' : 'text-red-800'}">
                                    ${applicationData.hasSchoolResults ? `<i class="fas fa-check mr-1"></i>${escapeHtml(applicationData.fileInfo?.resultsCert?.name || '')}` : 'Not uploaded (Required)'}
                                </p>
                            </div>
                        </div>
                        ${applicationData.fileInfo?.attachments?.length > 0 ? `
                        <div class="pt-2">
                            <p class="text-xs font-semibold text-slate-700 mb-2">Additional Documents (${applicationData.fileInfo.attachments.length})</p>
                            <div class="space-y-1">
                                ${applicationData.fileInfo.attachments.map(f => `
                                    <div class="flex items-center gap-2 p-2 bg-slate-100 rounded text-xs">
                                        <i class="fas fa-file text-blue-900 flex-shrink-0"></i>
                                        <span class="truncate text-slate-700">${escapeHtml(f.name)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </section>
            `;
            
            document.getElementById('review-content').innerHTML = contentHtml;
            
            // Update files notice visibility
            if (!applicationData.hasPaymentReceipt || !applicationData.hasSchoolResults) {
                document.getElementById('files-notice').classList.remove('hidden');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Edit button - go back to apply form
            document.getElementById('edit-btn').addEventListener('click', () => {
                window.location.href = 'apply.html';
            });

            // Confirmation checkbox
            document.getElementById('confirm').addEventListener('change', (e) => {
                const submitBtn = document.getElementById('submit-btn');
                const filesValid = applicationData.hasPaymentReceipt && applicationData.hasSchoolResults;
                submitBtn.disabled = !e.target.checked || !filesValid;
            });

            // Submit button
            document.getElementById('submit-btn').addEventListener('click', submitApplication);
        }

        // Submit application
        async function submitApplication() {
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            
            // Show submitting modal
            document.getElementById('submitting-modal').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '10%';
            
            try {
                const formData = new FormData();
                
                // Add all text fields from applicationData
                Object.keys(applicationData).forEach(key => {
                    if (key !== 'fileInfo' && key !== 'hasPaymentReceipt' && key !== 'hasSchoolResults') {
                        const value = applicationData[key] || '';
                        formData.append(key, value);
                        // Debug log for subjects
                        if (key === 'subjectsGrades') {
                            console.log('Sending subjectsGrades:', value);
                        }
                    }
                });
                
                // Add actual files from applicationFiles variable (loaded from sessionStorage)
                if (applicationFiles) {
                    console.log('Preparing files for submission:', {
                        proofOfPayment: applicationFiles.proofOfPayment ? `${applicationFiles.proofOfPayment.name} (${applicationFiles.proofOfPayment.size} bytes)` : 'null',
                        resultsCert: applicationFiles.resultsCert ? `${applicationFiles.resultsCert.name} (${applicationFiles.resultsCert.size} bytes)` : 'null',
                        attachments: applicationFiles.attachments.length
                    });
                    
                    if (applicationFiles.proofOfPayment) {
                        formData.append('attachments', applicationFiles.proofOfPayment);
                        console.log('✓ Added proofOfPayment:', applicationFiles.proofOfPayment.name);
                    }
                    if (applicationFiles.resultsCert) {
                        formData.append('attachments', applicationFiles.resultsCert);
                        console.log('✓ Added resultsCert:', applicationFiles.resultsCert.name);
                    }
                    if (applicationFiles.attachments && applicationFiles.attachments.length > 0) {
                        for (let i = 0; i < applicationFiles.attachments.length; i++) {
                            formData.append('attachments', applicationFiles.attachments[i]);
                            console.log('✓ Added attachment', i + 1, ':', applicationFiles.attachments[i].name);
                        }
                    }
                } else {
                    console.error('ERROR: applicationFiles object is empty or undefined');
                }

                // Update progress
                document.getElementById('progress-bar').style.width = '30%';
                
                // Send to server
                const response = await fetch('/submit', {
                    method: 'POST',
                    body: formData
                });
                
                // Update progress
                document.getElementById('progress-bar').style.width = '85%';
                
                if (response.ok) {
                    // Complete progress
                    document.getElementById('progress-bar').style.width = '100%';
                    
                    // Wait a moment then show success
                    await new Promise(r => setTimeout(r, 500));
                    
                    document.getElementById('submitting-modal').classList.add('hidden');
                    
                    const responseData = await response.json();
                    
                    // Update success message with applicant name
                    const name = applicationData.firstname || 'Applicant';
                    const program = applicationData.choice1 || 'your selected program';
                    
                    // Check if email was sent
                    if (responseData.emailSent === false) {
                        document.getElementById('success-message').innerHTML = 
                            `Thank you, <strong>${escapeHtml(name)}</strong>. Your application for <strong>${escapeHtml(program)}</strong> has been received and submitted to our admissions team.<br><br><span class="text-sm text-yellow-700">Note: We were unable to send a confirmation email, but your application has been recorded.</span>`;
                    } else {
                        document.getElementById('success-message').innerHTML = 
                            `Thank you, <strong>${escapeHtml(name)}</strong>. Your application for <strong>${escapeHtml(program)}</strong> has been submitted successfully.`;
                    }
                    
                    document.getElementById('successModal').classList.remove('hidden');
                    
                    // Clear session data and IndexedDB
                    sessionStorage.removeItem('applicationData');
                    sessionStorage.removeItem('applicationFiles');
                    sessionStorage.removeItem('applicationFileData');
                    applicationFiles = { proofOfPayment: null, resultsCert: null, attachments: [] };
                    window.persistedApplicationFiles = null;
                    
                    // Clear IndexedDB
                    try {
                        const db = await openIndexedDB();
                        const tx = db.transaction('applicationFiles', 'readwrite');
                        await tx.objectStore('applicationFiles').clear();
                    } catch (e) {
                        console.warn('Could not clear IndexedDB:', e);
                    }
                } else {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || 'Submission failed');
                }
            } catch (err) {
                console.error('Submit error:', err);
                document.getElementById('submitting-modal').classList.add('hidden');
                document.getElementById('error-message').textContent = err.message || 'An error occurred. Please try again.';
                document.getElementById('errorModal').classList.remove('hidden');
                btn.disabled = false;
            }
        }

        // Close error modal
        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text || '').replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>